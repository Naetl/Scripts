--[[
    TDS TOWER STACKER & MULTIPLIER V2.EXE
    ---------------------------------------------------------
    1/3/2026 version
    Description: 
    Intercepts "Place" requests to duplicate towers horizontally.
    
    Features:
    - Retro Windows 95 UI Style
    - Recursive Hook Protection (Anti-Crash)
    - Auto-Off: Disables mod automatically after sequence finish
    - Fixed Height: Force-locks Y-axis to 95
    - Precise X-Offset: Increments 1.5 per unit
    - Safety Delay: 0.5s interval to prevent server kicks
    - Anti-Reset: UI persists after character death
    ---------------------------------------------------------
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local remote = ReplicatedStorage:WaitForChild("RemoteFunction")

-- // CONFIGURATION (Toggle Axis Here) # CHANGEABLE
local useXAxis = true -- SET TRUE untuk X (Samping), SET FALSE untuk Z (Depan/Belakang)
local offset_val = 1.2 -- THE GAP for each stacking

-- // State Variables
local isEnabled = false
local isProcessing = false 
local loopAmount = 1
local base_Y = 95


-- // Anti-Reset UI Logic
local playerGui = Players.LocalPlayer:WaitForChild("PlayerGui")
if playerGui:FindFirstChild("RetroTDS_UI") then playerGui.RetroTDS_UI:Destroy() end

local screenGui = Instance.new("ScreenGui", playerGui)
screenGui.Name = "RetroTDS_UI"
screenGui.ResetOnSpawn = false

-- // UI Window (Retro Style)
local frame = Instance.new("Frame", screenGui)
frame.Size = UDim2.new(0, 200, 0, 160)
frame.Position = UDim2.new(0.5, -100, 0.4, 0)
frame.BackgroundColor3 = Color3.fromRGB(192, 192, 192)
frame.BorderSizePixel = 2
frame.Active = true
frame.Draggable = true

local titleBar = Instance.new("Frame", frame)
titleBar.Size = UDim2.new(1, -4, 0, 22)
titleBar.Position = UDim2.new(0, 2, 0, 2)
titleBar.BackgroundColor3 = Color3.fromRGB(0, 0, 128)
titleBar.BorderSizePixel = 0

local titleText = Instance.new("TextLabel", titleBar)
titleText.Size = UDim2.new(1, -5, 1, 0)
titleText.Position = UDim2.new(0, 5, 0, 0)
titleText.Text = "TDS_STACKER_" .. (useXAxis and "X" or "Z") .. ".EXE"
titleText.TextColor3 = Color3.new(1, 1, 1)
titleText.Font = Enum.Font.Code
titleText.BackgroundTransparency = 1
titleText.TextXAlignment = Enum.TextXAlignment.Left

local toggleBtn = Instance.new("TextButton", frame)
toggleBtn.Size = UDim2.new(0.9, 0, 0, 35)
toggleBtn.Position = UDim2.new(0.05, 0, 0.25, 0)
toggleBtn.Text = "STATUS: OFF"
toggleBtn.Font = Enum.Font.Code

local amountInput = Instance.new("TextBox", frame)
amountInput.Size = UDim2.new(0.8, 0, 0, 30)
amountInput.Position = UDim2.new(0.1, 0, 0.68, 0)
amountInput.Text = "1"
amountInput.Font = Enum.Font.Code

-- // UI Logic
local function updateUI()
    toggleBtn.Text = isEnabled and "STATUS: ON" or "STATUS: OFF"
    toggleBtn.BackgroundColor3 = isEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(192, 192, 192)
end

toggleBtn.MouseButton1Click:Connect(function()
    isEnabled = not isEnabled
    updateUI()
end)

-- REAL-TIME UPDATE (No Enter Required)
amountInput:GetPropertyChangedSignal("Text"):Connect(function()
    local val = tonumber(amountInput.Text)
    if val then
        loopAmount = math.clamp(val, 1, 15)
    end
end)

-- Clean up text on focus lost
amountInput.FocusLost:Connect(function()
    amountInput.Text = tostring(loopAmount)
end)

-- // Metatable Hooking
local old_namecall
old_namecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    local args = {...}
    
    if isProcessing then 
        return old_namecall(self, ...) 
    end

    if not checkcaller() and isEnabled and method == "InvokeServer" and self.Name == "RemoteFunction" then
        local action = tostring(args[2])
        
        if action:find("Pl") and action:find("ce") then
            local towerName = args[4]
            local originalData = args[3]
            
            isProcessing = true 
            
            task.spawn(function()
                local currentX = originalData.Position.X
                local currentZ = originalData.Position.Z
                
                for i = 1, loopAmount do
                    local newPos = vector.create(currentX, base_Y, currentZ)
                    local newData = {Rotation = originalData.Rotation, Position = newPos}
                    
                    remote:InvokeServer("Troops", action, newData, towerName)
                    
                    -- LOGIKA TOGGLE AXIS
                    if useXAxis then
                        currentX = currentX + offset_val
                    else
                        currentZ = currentZ + offset_val
                    end
                    
                    task.wait(0.5) 
                end
                
                isEnabled = false
                isProcessing = false 
                updateUI()
            end)
            
            return nil 
        end
    end
    
    return old_namecall(self, ...)
end)
